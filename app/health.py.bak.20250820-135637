from flask import Blueprint, request, jsonify
import os

bp = Blueprint("health", __name__)

@bp.get("/version")
def version():
    return jsonify({
        "app": "icurabot",
        "build": os.getenv("ICURABOT_BUILD", "20250818"),
        "model_default": os.getenv("OPENAI_MODEL_DEFAULT", "gpt-4o-mini"),
        "model_upgrade": os.getenv("OPENAI_MODEL_UPGRADE", "gpt-4o"),
        "ok": True
    }), 200

def _get_client():
    from openai import OpenAI
    kw = {"api_key": os.environ["OPENAI_API_KEY"]}
    base_url = os.getenv("OPENAI_BASE_URL", "").rstrip("/")
    if base_url:
        kw["base_url"] = base_url
    api_version = os.getenv("OPENAI_API_VERSION")
    if api_version:
        kw["default_query"] = {"api-version": api_version}
    return OpenAI(**kw)

def _as_int(x, default=0):
    try:
        return int(x) if x is not None else default
    except Exception:
        return default

@bp.post("/chat")
def chat():
    data = request.get_json(silent=True) or {}
    user_msg = (data.get("message") or "").strip() or "Hello!"
    model = data.get("model") or os.getenv("OPENAI_MODEL_DEFAULT", "gpt-4o-mini")

    try:
        client = _get_client()
        resp = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": user_msg},
            ],
        )

        choice = resp.choices[0]
        content = getattr(choice, "message", None).content if hasattr(choice, "message") else getattr(choice, "text", "")
        usage = getattr(resp, "usage", None)

        usage_dict = None
        if usage:
            completion_tokens = None
            if hasattr(usage, "completion_tokens"):
                completion_tokens = usage.completion_tokens
            elif isinstance(usage, dict):
                completion_tokens = usage.get("completion_tokens")
            usage_dict = {
                "prompt_tokens": _as_int(getattr(usage, "prompt_tokens", None) if hasattr(usage, "prompt_tokens") else (usage.get("prompt_tokens") if isinstance(usage, dict) else None)),
                "completion_tokens": _as_int(completion_tokens),
                "total_tokens": _as_int(getattr(usage, "total_tokens", None) if hasattr(usage, "total_tokens") else (usage.get("total_tokens") if isinstance(usage, dict) else None)),
            }

        res = {"ok": True, "model": getattr(resp, "model", model), "message": content}
        if usage_dict:
            res["usage"] = usage_dict

        return jsonify(res), 200

    except Exception as e:
        return jsonify({"ok": False, "error": str(e)}), 500
